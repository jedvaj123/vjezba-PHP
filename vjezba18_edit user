<?php
$host = "127.0.0.1";
$db   = "registracija_db";
$user = "app_user";
$pass = "AppUser_2026!";

$conn = new mysqli($host, $user, $pass, $db);
if ($conn->connect_error) die("Greška spajanja: " . $conn->connect_error);
$conn->set_charset("utf8mb4");

$id = isset($_GET["id"]) ? (int)$_GET["id"] : 0;
if ($id <= 0) die("Neispravan ID.");

$countries = [];
$cr = $conn->query("SELECT id, name FROM countries ORDER BY name");
while ($cr && $row = $cr->fetch_assoc()) $countries[] = $row;

$stmt = $conn->prepare("SELECT id, first_name, last_name, country_id FROM users WHERE id = ?");
$stmt->bind_param("i", $id);
$stmt->execute();
$userRes = $stmt->get_result();
$userRow = $userRes->fetch_assoc();
$stmt->close();

if (!$userRow) die("Korisnik ne postoji.");

$errors = [];
$success = "";

$first = $userRow["first_name"];
$last  = $userRow["last_name"];
$country_id = (int)$userRow["country_id"];

if ($_SERVER["REQUEST_METHOD"] === "POST") {
  $first = trim($_POST["first_name"] ?? "");
  $last  = trim($_POST["last_name"] ?? "");
  $country_id = (int)($_POST["country_id"] ?? 0);

  if ($first === "") $errors[] = "Ime je obavezno.";
  if ($last === "")  $errors[] = "Prezime je obavezno.";
  if ($country_id <= 0) $errors[] = "Odaberi državu.";

  if (!$errors) {
    $up = $conn->prepare("UPDATE users SET first_name = ?, last_name = ?, country_id = ? WHERE id = ?");
    $up->bind_param("ssii", $first, $last, $country_id, $id);

    if ($up->execute()) {
      $success = "Korisnik je ažuriran.";
    } else {
      $errors[] = "Greška pri ažuriranju.";
    }
    $up->close();
  }
}
?>
<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8">
  <title>Edit user</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .wrap { max-width: 420px; }
    label { font-weight: 700; display:block; margin-top: 12px; }
    input, select { width: 100%; padding: 10px; margin-top: 6px; box-sizing: border-box; }
    button { margin-top: 14px; padding: 12px; width: 100%; border:0; background:#3dbb4a; color:#fff; cursor:pointer; }
    .err { background:#ffe3e3; border:1px solid #ff9b9b; padding:10px; margin-top:12px; }
    .ok { background:#e6ffea; border:1px solid #8ad18a; padding:10px; margin-top:12px; }
    .back { display:inline-block; margin-top:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>Edit user</h2>

  <?php if ($errors): ?>
    <div class="err"><?php foreach ($errors as $e) echo htmlspecialchars($e) . "<br>"; ?></div>
  <?php endif; ?>

  <?php if ($success): ?>
    <div class="ok"><?php echo htmlspecialchars($success); ?></div>
  <?php endif; ?>

  <form method="post">
    <label>First name</label>
    <input type="text" name="first_name" value="<?php echo htmlspecialchars($first); ?>">

    <label>Last name</label>
    <input type="text" name="last_name" value="<?php echo htmlspecialchars($last); ?>">

    <label>Country</label>
    <select name="country_id">
      <option value="0">molimo odaberite</option>
      <?php foreach ($countries as $c): ?>
        <option value="<?php echo (int)$c["id"]; ?>" <?php echo ((int)$c["id"] === (int)$country_id ? "selected" : ""); ?>>
          <?php echo htmlspecialchars($c["name"]); ?>
        </option>
      <?php endforeach; ?>
    </select>

    <button type="submit">Spremi</button>
  </form>

  <a class="back" href="users.php">← Nazad na listu</a>
</div>
</body>
</html>
<?php $conn->close(); ?>
